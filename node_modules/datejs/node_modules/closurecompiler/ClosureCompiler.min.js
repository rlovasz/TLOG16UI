/*
 ClosureCompiler.js (c) 2013 Daniel Wirtz <dcode@dcode.io>
 Released under the Apache License, Version 2.0
 see: https://github.com/dcodeIO/ClosureCompiler.js for details
*/
(function(x){if("function"!=typeof require||!module||!module.exports||!process)throw Error("ClosureCompiler.js can only be used within node.js");var m=require("path"),h=require("fs"),t=require("child_process"),u=require("bl");h.existsSync||(h.existsSync=m.existsSync);var d=function(c){this.options="object"===typeof c&&c?c:{}};d._assertOption=function(c,d,k){if(0>k.indexOf(d))throw"Illegal "+c+" value: "+d+" ("+k+" expected)";};d.JAVA_EXT="win32"==process.platform?".exe":"";d.getGlobalJava=function(){var c=
null;process.env.JAVA_HOME&&(c=m.join(process.env.JAVA_HOME,"bin","java"+d.JAVA_EXT),h.existsSync(c)||(c=null));c||(c="java");return c};d.getBundledJava=function(){return m.normalize(m.join(__dirname,"jre","bin","java"+d.JAVA_EXT))};d.testJava=function(c,d){t.exec('"'+c+'" -version',{},function(c,h,p){p+="";p.match(/1\.[7-8]+/)?d(!0,null):0<=p.indexOf('version "')?d(!1,Error("Not Java 7")):d(!1,c)})};d.compile=function(c,h,k,m){4>arguments.length&&(m=k,k=null);(new d(h)).compile(c,k,m)};d.prototype.compile=
function(c,q,k){function w(a,c,b,d){var e=u(),f=u();a=t.spawn(a,c,{stdio:[b||"ignore","pipe","pipe"]});a.stdout.pipe(e);a.stderr.pipe(f);a.on("exit",function(a,c){var b;a&&(b=Error(a),b.code=a,b.signal=c);d(b,e,f)});a.on("error",function(a){d(a,e,f)})}function p(a,b){w(a,b,q,function(a,b,c){0<b.length||0<c.length?k(c+"",b+""):k(a,null)})}3>arguments.length&&(k=q,q=null);for(var b={},g=Object.keys(this.options),a=0;a<g.length;a++)b[g[a].toLowerCase()]=this.options[g[a]];delete b.js;delete b.js_output_file;
var a=b.xms||null,e=b.xmx||"1024m";delete b.xms;delete b.xmx;var r;if(b.compiler_jar)r=b.compiler_jar;else{var v=__dirname+"/compiler";h.readdirSync(v).forEach(function(a){-1!==a.indexOf("closure-compiler")&&(r=v+"/"+a)})}var l=["-XX:+TieredCompilation"];a&&l.push("-Xms"+a);l.push("-Xmx"+e,"-jar",r);c instanceof Array||(c=[c]);for(a=0;a<c.length;a++){if("string"!=typeof c[a])throw Error("Illegal source file: "+c[a]);if(0<=c[a].indexOf('"'))l.push("--js="+c[a]);else{e=h.statSync(c[a]);if(!e.isFile())throw Error("Source file not found: "+
c[a]);l.push("--js",c[a])}}b.externs||(b.externs=[]);b.externs instanceof Array||(b.externs=[b.externs]);g=[];for(a=0;a<b.externs.length;a++){if("string"!=typeof b.externs[a]||""==b.externs[a])throw Error("Externs directive does not point to a file or directory: "+b.externs[a]);"node"==b.externs[a].toLowerCase()&&(b.externs[a]=__dirname+"/node_modules/closurecompiler-externs");e=h.statSync(b.externs[a]);if(e.isDirectory())for(var n=h.readdirSync(b.externs[a]),e=0;e<n.length;e++){var f=b.externs[a]+
"/"+n[e];h.statSync(f).isFile()&&".js"==m.extname(f).toLowerCase()&&g.push(f)}else if(e.isFile())g.push(b.externs[a]);else throw Error("Externs file not found: "+b.externs[a]);}delete b.externs;for(a=0;a<g.length;a++)l.push("--externs",g[a]);g=Object.keys(b);for(a=0;a<g.length;a++){n=g[a];f=b[g[a]];if(!/[a-zA-Z0-9_]+/.test(n))throw Error("Illegal option: "+n);if(!0===f)l.push("--"+n);else if(!1!==f)for(f instanceof Array||(f=[f]),e=0;e<f.length;e++){if(!/[^\s]*/.test(f[e]))throw Error("Illegal value for option "+
n+": "+f[e]);l.push("--"+n,f[e])}}d.testJava(d.getGlobalJava(),function(a){a?p(d.getGlobalJava(),l):d.testJava(d.getBundledJava(),function(a){if(a)p(d.getBundledJava(),l);else throw Error("Java is not available, neither the bundled nor a global one.");})})};d.prototype.toString=function(){return"ClosureCompiler"};module.exports=d})(this);
